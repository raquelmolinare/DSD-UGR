<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Sensor</title>

		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>

	</head>


	<body>

		<div class="row d-flex justify-content-center align-items-center mt-5">
			<div class="row w-75 d-flex justify-content-center align-items-center mb-4"  style="margin:auto">
				<div class="col p-3 a shadow rounded bg-dark" style=" height: fit-content;">
					<h2 class="text-white" style="border-bottom: 1px solid white">PANEL DE CONTROL DE SENSORES</h2>
					<div class="row">
						<div class="col">

							<div class="row  text-white d-flex justify-content-center align-items-center">
								<div class="col m-1 p-3">
									<div class="col p-2 border border-secondary rounded">
										<form action="javascript:void(0);" onsubmit="javascript:enviarTemperatura();">
											<h3 style="border-bottom: 1px solid white">Temperatura:</h3>
											<div class="form-group p-3 pt-1">


												<input type="text" class="form-control" id="temperaturanew" placeholder="Introduce un valor">
												<input type="submit" class="btn btn-primary mt-2 w-100" value="Cambiar" />


											</div>
										</form>
									</div>
								</div>
								<div class="col m-1  p-3">
									<div class="col p-2 border border-secondary rounded">
										<form action="javascript:void(0);" onsubmit="javascript:enviarLuminosidad();">
											<h3 style="border-bottom: 1px solid white">Luminosidad:</h3>
											<div class="form-group p-3 pt-1">


												<input type="text" class="form-control" id="luminosidadnew" placeholder="Introduce un valor">
												<input type="submit" class="btn btn-primary mt-2 w-100" value="Cambiar" />


											</div>
										</form>
									</div>
								</div>
								<div class="col m-1 p-3">
									<div class="col p-2 border border-secondary rounded">
										<form action="javascript:void(0);" onsubmit="javascript:enviarHumedad();">
											<h3 style="border-bottom: 1px solid white">Humedad:</h3>
											<div class="form-group p-3 pt-1">


												<input type="text" class="form-control" id="humedadnew" placeholder="Introduce un valor">
												<input type="submit" class="btn btn-primary mt-2 w-100" value="Cambiar" />


											</div>
										</form>
									</div>
								</div>
								<div class="col m-1">
									<div class="col p-2 border border-secondary rounded">
										<form action="javascript:void(0);" onsubmit="javascript:enviarCalidadAire();">
											<h3 style="border-bottom: 1px solid white">Calidad Aire:</h3>
											<div class="form-group p-3 pt-1">


												<input type="text" class="form-control" id="calidadairenew" placeholder="Introduce un valor">
												<input type="submit" class="btn btn-primary mt-2 w-100" value="Cambiar" />


											</div>
										</form>
									</div>
								</div>

								<div class="col m-1">
									<div class="col p-2 border border-secondary rounded">
										<form action="javascript:void(0);" onsubmit="javascript:enviarMovimiento();">
											<h3 style="border-bottom: 1px solid white">Movimiento:</h3>
											<div class="form-group p-3 pt-1">

												<input type="submit" class="btn btn-primary mt-2 w-100" value="Cambiar" />

											</div>
										</form>
									</div>
								</div>
							</div>

							<div class="row  d-flex justify-content-center">
								<div class="col-5 m-3 p-2 rounded" style="background-color: #F3F3F3">
									<h4 style="border-bottom: 1px solid black">Sensores</h4>
									<div class="col p-3">

										<h5 class="alert bg-light border border-dark text-center">Temperatura: <span id="temperatura" class="text-primary" style="font-weight: bolder"> </span> ºC</h5>
										<h5 class="alert  bg-light border border-dark text-center">Luminosidad: <span id="luminosidad" class="text-primary" style="font-weight: bolder"> </span> Lux</h5>
										<h5 class="alert  bg-light border border-dark text-center">Humedad: <span id="humedad" class="text-primary" style="font-weight: bolder"> </span> %</h5>
										<h5 class="alert  bg-light border border-dark text-center">Calidad del aire: <span id="calidad" class="text-primary" style="font-weight: bolder"> </span>  ICA</h5>
										<h5 class="alert  bg-light border border-dark text-center">Movimiento: <span id="movimiento" class="text-primary" style="font-weight: bolder"> </span> </h5>

									</div>
								</div>
								<div class="col-3 m-3 p-2" style="background-color: #F3F3F3">
									<h4 style="border-bottom: 1px solid black">Actuadores</h4>
									<div class="col p-2">

										<h5 id="infoAC" class="text-center rounded-pill p-3" style="font-weight: bold">AC</h5>
										<h5 id="infocalefaccion" class="text-center rounded-pill p-3" style="font-weight: bold">Calefaccion</h5>
										<h5 id="infopersiana" class="text-center rounded-pill p-3" style="font-weight: bold">Persiana</h5>
										<h5 id="infohumidificador" class="text-center rounded-pill p-3" style="font-weight: bold">Humidificador</h5>
										<h5 id="infoluces" class="text-center rounded-pill p-3" style="font-weight: bold">Luces</h5>
										<h5 id="infopurificador" class="text-center rounded-pill p-3" style="font-weight: bold">Purificador</h5>

									</div>
								</div>

								<div class="col-3 m-3 p-2" style="background-color: #F3F3F3">
									<h4 style="border-bottom: 1px solid black">Clientes</h4>
									<div class="col p-2" id="lista_usuarios">

									</div>
								</div>

							</div>
						</div>

						<!--
						<div class="col-3 p-2 rounded" style="background-color: #F3F3F3">
							<form action="javascript:void(0);" onsubmit="javascript:obtenerHistorial();">
								<input type="submit" class="btn btn-primary mt-2 w-100" value="Refrescar historial" />
							</form>

							<div id="historial" class="" style="max-height:30em; overflow-y: scroll;">

							</div>

						</div>
						-->
					</div>
				</div>
			</div>
		</div>

	</body>


	<script src="/socket.io/socket.io.js"></script>
	<script type="text/javascript">

		var serviceURL = document.URL;
		var socket = io.connect("http://localhost:8080"); //Se conecta a la url donde el servidor ofrece el servicio

		var LUM;
		var TEMP;
		var HUMEDAD;
		var CALIDAD_AIRE;
		var MOVIMIENTO;

		var host = undefined;
		var port = undefined;
		var id = undefined;

		function actualizarLista(usuarios){
			var listContainer = document.getElementById('lista_usuarios');
			listContainer.innerHTML = '';
			var listElement = document.createElement('ul');
			listContainer.appendChild(listElement);
			var num = usuarios.length;
			for(var i=0; i<num; i++) {
	            var listItem = document.createElement('li');
	            listItem.innerHTML = usuarios[i].address+":"+usuarios[i].port;
	            listElement.appendChild(listItem);
	        }
	    }

		function actualizarResultados(resultados){
			//SENSORES
			document.getElementById('temperatura').innerHTML = resultados.temperatura ;
			TEMP = resultados.temperatura;

			document.getElementById('luminosidad').innerHTML = resultados.luminosidad ;
			LUM = resultados.luminosidad;

			document.getElementById('humedad').innerHTML = resultados.humedad ;
			HUMEDAD = resultados.humedad

			document.getElementById('calidad').innerHTML = resultados.calidadAire ;
			CALIDAD_AIRE = resultados.calidadAire

			document.getElementById('movimiento').innerHTML = resultados.movimiento ;
			MOVIMIENTO = resultados.movimiento ;


			//ACTUADORES
			if(resultados.estadoAC){
				document.getElementById('infoAC').classList.remove('alert-danger');
				document.getElementById('infoAC').classList.add('alert-success');
			}else{
				document.getElementById('infoAC').classList.remove('alert-success');
				document.getElementById('infoAC').classList.add('alert-danger');

			}

			if(resultados.estadoPersiana){
				document.getElementById('infopersiana').classList.remove('alert-danger');
				document.getElementById('infopersiana').classList.add('alert-success');
			}else{
				document.getElementById('infopersiana').classList.remove('alert-success');
				document.getElementById('infopersiana').classList.add('alert-danger');
			}

			if(resultados.estadoCalefaccion){
				document.getElementById('infocalefaccion').classList.remove('alert-danger');
				document.getElementById('infocalefaccion').classList.add('alert-success');
			}else{
				document.getElementById('infocalefaccion').classList.remove('alert-success');
				document.getElementById('infocalefaccion').classList.add('alert-danger');
			}

			if(resultados.estadoHumidificador){
				document.getElementById('infohumidificador').classList.remove('alert-danger');
				document.getElementById('infohumidificador').classList.add('alert-success');
			}else{
				document.getElementById('infohumidificador').classList.remove('alert-success');
				document.getElementById('infohumidificador').classList.add('alert-danger');
			}

			if(resultados.estadoPurificador){
				document.getElementById('infopurificador').classList.remove('alert-danger');
				document.getElementById('infopurificador').classList.add('alert-success');
			}else{
				document.getElementById('infopurificador').classList.remove('alert-success');
				document.getElementById('infopurificador').classList.add('alert-danger');
			}

			if(resultados.estadoLuces){
				document.getElementById('infoluces').classList.remove('alert-danger');
				document.getElementById('infoluces').classList.add('alert-success');
			}else{
				document.getElementById('infoluces').classList.remove('alert-success');
				document.getElementById('infoluces').classList.add('alert-danger');
			}
	    }

		function actualizarHistorial(eventos){
			var listContainer = document.getElementById('historial');

			var num = eventos.length;
			for(var i=0; i<num; i++) {
				var listElement = document.createElement('p');
				listElement.classList.add('m-2');
				listElement.classList.add('p-2');
				listElement.classList.add('rounded');
				listElement.classList.add('bg-white');
				listElement.innerHTML = eventos[i].client+" a realizado un: "+eventos[i].change+" <br>-- "+eventos[i].time;
				listContainer.appendChild(listElement);
			}
		}

		function enviarTemperatura(){
			//Obtener los valores del formulario
			var temp = document.getElementById("temperaturanew").value;

			var d = new Date();
			var info = {client: id, port: port, time: d, change: "Cambio de temperatura a "+temp};

            socket.emit('sensor-changes', {temperaturaNew: temp, luminosidadNew: LUM, humedadNew: HUMEDAD, calidadAireNew: CALIDAD_AIRE, movimientoNew: MOVIMIENTO, info: info} );

			return false;
        }

		function enviarLuminosidad(){
			//Obtener los valores del formulario y el correspondiente div
			var lum = document.getElementById("luminosidadnew").value;

			var d = new Date();
			var info = {client: id, port: port, time: d, change: "Cambio de luminosidad a "+lum};

			socket.emit('sensor-changes',  {temperaturaNew: TEMP, luminosidadNew: lum, humedadNew: HUMEDAD, calidadAireNew: CALIDAD_AIRE, movimientoNew: MOVIMIENTO, info: info} );

			return false;
		}

		function enviarHumedad(){
			//Obtener los valores del formulario y el correspondiente div
			var hum = document.getElementById("humedadnew").value;

			var d = new Date();
			var info = {client: id, port: port, time: d, change: "Cambio de humedad a "+hum};

			socket.emit('sensor-changes', {temperaturaNew: TEMP, luminosidadNew: LUM, humedadNew: hum, calidadAireNew: CALIDAD_AIRE, movimientoNew: MOVIMIENTO, info: info} );

			return false;
		}

		function enviarCalidadAire(){
			//Obtener los valores del formulario y el correspondiente div
			var cal = document.getElementById("calidadairenew").value;

			var d = new Date();
			var info = {client: id, port: port, time: d, change: "Cambio de calidad de aire a "+cal};

			socket.emit('sensor-changes',  {temperaturaNew: TEMP, luminosidadNew: LUM, humedadNew: HUMEDAD, calidadAireNew: cal, movimientoNew: MOVIMIENTO, info: info} );

			return false;
		}

		function enviarMovimiento(){
			//Obtener los valores del formulario y el correspondiente div
			var mov;
			if( MOVIMIENTO ){
				mov = false;

			}
			else{
				mov = true;
			}

			var d = new Date();
			var info = {client: id, port: port, time: d, change: "Cambio de movimiento a "+mov};

			socket.emit('sensor-changes', {temperaturaNew: TEMP, luminosidadNew: LUM, humedadNew: HUMEDAD, calidadAireNew: CALIDAD_AIRE, movimientoNew: mov, info: info} );

			return false;
		}


		//Conexion con el servicio
		socket.on('connect', function(){
			socket.emit('output-evt', 'Hola Servicio!');
		});

		//Obtencion de datos de conexion
		socket.on('my-address', function(data) {
			host = data.host;
			port = data.port;
			id = data.id;
		});

		//Obtencion de valores inicial tras la conexión
		socket.on('output-evt', function(data) {
			console.log('Recibo los datos tras la conexion');
			actualizarResultados(data);
		});

		//Actualización de datos por cambios
		socket.on('all-values', function(data) {
			console.log('Recibo un mensaje para que actualice los datos');
			actualizarResultados(data);
		});

		//Actualización de los usuarios en el sistema
		socket.on('all-connections', function(data) {
			actualizarLista(data);
		});


		//Recibe un evento para conocer el historial de cmabios
		socket.on('event-history', function(data) {
			actualizarHistorial(data);
		});

		//Recepcion de la desconexion del servidor
		socket.on('disconnect', function() {
			actualizarResultados("El servicio ha dejado de funcionar!!");
		});

	</script>

</html>
